#!/usr/bin/env bash

# If -r is defined do not check, we may be running pacstrap
if [[ ! $@ =~ (-r|--root) ]]; then
	# Check if the disk is ro'ed using subvolume properties
	if btrfs property get / 2> /dev/null | grep -q 'ro=true'; then
		cat <<- END
			The root partition is currently in read-only mode, to run pacman it will have to be switched over to read-write mode.

			Note that any changes made to the system will not carry over to future OS image updates.

		END
		if [[ ! $EUID -eq 0 ]]; then
			printf 'You have to be root to unlock the root partiiton. Please recall with sudo!\n'
			exit 1
		fi
		read -p 'Do you want to unlock the root partition? (y/N) ' ans

		if [[ $ans =~ ^(y|Y|yes|YES)$ ]]; then
			btrfs property set / ro false
		else
			printf 'Quitting... no changes have been made to the system.\n'
			exit 1
		fi
	fi
fi

# No exit statement here, we return pacman's exit code
/usr/bin/pacman $@
